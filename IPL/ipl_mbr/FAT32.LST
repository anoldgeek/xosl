Turbo Assembler	 Version 3.1	    09/03/18 18:04:28	    Page 1
fat32.asm



      1					 ;
      2					 ; Extended Operating System Loader (XOSL)
      3					 ; Copyright (c) 1999 by Geurt Vos
      4					 ;
      5					 ; This	code is	distributed under GNU General Public License (GPL)
      6					 ;
      7					 ; The full text of the	license	can be found in	the GPL.TXT file,
      8					 ; or at http://www.gnu.org
      9					 ;
     10
     11					 ;/*
     12					 ; * File  : FAT32.ASM
     13					 ; * Author: Geurt Vos
     14					 ; * Date  : March 1999
     15					 ; *
     16					 ; * Reads a file from a 'mounted' FAT32 partition
     17					 ; */
     18
     19	    0000					 .model	 tiny
     20							 .386p
     21
     22	00000000			 TFAT32DirEntry	 struc
     23	00000000  01*(08*(??))			 FileName	 db	 8 dup (?)
     24	00000008  01*(03*(??))			 Extension	 db	 3 dup (?)
     25	0000000B  01*(??)			 Attribute	 db	 ?
     26	0000000C  01*(????)			 NT		 dw	 ?
     27	0000000E  01*(????)			 CreateTime	 dw	 ?
     28	00000010  01*(????)			 CreateDate	 dw	 ?
     29	00000012  01*(????)			 Accessed	 dw	 ?
     30	00000014  01*(????)			 StartClusterH	 dw	 ?
     31	00000016  01*(????)			 Time		 dw	 ?
     32	00000018  01*(????)			 Date		 dw	 ?
     33	0000001A  01*(????)			 StartClusterL	 dw	 ?
     34	0000001C  01*(????????)			 FileSize	 dd	 ?
     35	00000020			 TFAT32DirEntry	 ends
     36
     37		  =1000			 INMEMCLUST	 equ	 4096
     38		  =000C			 INMEMCLUSTPWR	 equ	 12		 ;4096 == 2**12
     39		  =-1000		 INMEMCLUSTSCALE equ	 not (INMEMCLUST - 1)
     40
     41		  =0020			 FATSECTCOUNT	 equ	 INMEMCLUST / 128
     42		  =0005			 FATSECTCNTPWR	 equ	 INMEMCLUSTPWR - 7	 ;128 clust/sect
     43
     44	    0000					 .data
     45							 extrn	 ClusterSectSize: word
     46							 extrn	 ClusterByteSize: word
     47							 extrn	 FATStart: dword
     48							 extrn	 DataStart: dword
     49							 extrn	 RootCluster: dword
     50
     51	    0000					 .data?
     52	    0000  1000*(????)		 FAT		 dw	 INMEMCLUST dup	(?)
     53	    2000  4000*(??)		 Root		 db	 16384 dup (?)
     54
     55	    6000					 .code
     56							 public	 ReadFile
     57							 extrn	 ReadSectors: near
Turbo Assembler	 Version 3.1	    09/03/18 18:04:28	    Page 2
fat32.asm



     58							 extrn	 MemCompare: near
     59
     60					 ;int ReadFile(const char *FileName, void *Buffer)
     61	    0000			 ReadFile	 proc
     62	    0000  55					 push	 bp
     63	    0001  8B EC					 mov	 bp,sp
     64	    0003  66| 56				 push	 esi
     65	    0005  66| 57				 push	 edi
     66
     67	    0007  E8 0026				 call	 Locate
     68	    000A  0B C0					 or	 ax,ax
     69	    000C  75 1C	90 90				 jne	 ReadFileExit
     70	    0010  66| 8B 7E 08				 mov	 edi,[bp + 8]
     71
     72	    0014  E8 00B1		 ReadLoop:	 call	 ReadCluster
     73	    0017  A1 0000e				 mov	 ax,ClusterByteSize
     74	    001A  03 F8					 add	 di,ax
     75	    001C  E8 006B				 call	 GetNextCluster
     76	    001F  66| 81 FE 0FFFFFFF			 cmp	 esi,0fffffffh		 ;FAT32	has 28bit clusters
     77	    0026  75 EC					 jne	 ReadLoop
     78	    0028  33 C0					 xor	 ax,ax
     79
     80	    002A  66| 5F		 ReadFileExit:	 pop	 edi
     81	    002C  66| 5E				 pop	 esi
     82	    002E  5D					 pop	 bp
     83	    002F  C3					 ret
     84	    0030			 ReadFile	 endp
     85
     86					 ;Locate
     87					 ;	 Locate	the first cluster of a file
     88					 ; Entry:
     89					 ;	 dword ptr [bp + 4] -> FileName
     90					 ; Return:
     91					 ;	 esi = StartCluster
     92					 ;	 ax = success ?	0 : -1
     93	    0030			 Locate		 proc
     94
     95	    0030  66| 8B 36 0000e			 mov	 esi,RootCluster
     96	    0035  8C DF					 mov	 di,ds
     97	    0037  66| C1 E7 10				 shl	 edi,16
     98	    003B  BF 2000r				 mov	 di,offset Root
     99
    100	    003E  E8 0087		 LReadLoop:	 call	 ReadCluster
    101	    0041  33 C9					 xor	 cx,cx
    102
    103	    0043  8B D9			 LFindEntryLoop: mov	 bx,cx
    104	    0045  81 C3	2000r				 add	 bx,offset Root
    105	    0049  80 3F	00				 cmp	 [bx].FileName[0],0
    106	    004C  74 38	90 90				 je	 NotFoundExit
    107
    108	    0050  51					 push	 cx
    109	    0051  6A 0B					 push	 word ptr 11
    110	    0053  66| FF 76 04				 push	 dword ptr [bp + 4]
    111	    0057  1E					 push	 ds
    112	    0058  53					 push	 bx
    113	    0059  E8 0000e				 call	 MemCompare
    114	    005C  83 C4	0A				 add	 sp,10
Turbo Assembler	 Version 3.1	    09/03/18 18:04:28	    Page 3
fat32.asm



    115	    005F  59					 pop	 cx
    116	    0060  0B C0					 or	 ax,ax
    117	    0062  75 0D	90 90				 jnz	 LNextEntry
    118
    119	    0066  8B 77	14				 mov	 si,[bx].StartClusterH
    120	    0069  66| C1 E6 10				 shl	 esi,16
    121	    006D  8B 77	1A				 mov	 si,[bx].StartClusterL
    122	    0070  C3					 ret
    123
    124	    0071  83 C1	20		 LNextEntry:	 add	 cx,32
    125	    0074  3B 0E	0000e				 cmp	 cx,ClusterByteSize
    126	    0078  72 C9					 jb	 LFindEntryLoop
    127
    128
    129	    007A  E8 000D				 call	 GetNextCluster
    130	    007D  66| 81 FE 0FFFFFFF			 cmp	 esi,0fffffffh		 ;FAT32	has 28bit clusters
    131	    0084  75 B8					 jne	 LReadLoop
    132
    133	    0086  B8 FFFF		 NotFoundExit:	 mov	 ax,-1
    134	    0089  C3					 ret
    135	    008A			 Locate		 endp
    136
    137					 ;GetNextCluster
    138					 ; Entry:
    139					 ;	 esi = cluster
    140					 ;
    141	    008A			 GetNextCluster	 proc
    142	    008A  E8 0013				 call	 ReadFAT
    143	    008D  66| 8B DE				 mov	 ebx,esi
    144	    0090  66| 2B D8				 sub	 ebx,eax
    145	    0093  66| C1 E3 02				 shl	 ebx,2
    146	    0097  66| 67| 8B B3	      +			 mov	 esi,[ebx + offset FAT]
    147		  00000000r
    148	    009F  C3					 ret
    149	    00A0			 GetNextCluster	 endp
    150
    151					 ;ReadFAT
    152					 ; Entry:
    153					 ;	 esi = Cluster
    154	    00A0			 ReadFAT	 proc
    155	    00A0  66| 8B C6				 mov	 eax,esi
    156	    00A3  66| C1 E8 0C				 shr	 eax,INMEMCLUSTPWR
    157	    00A7  66| C1 E0 05				 shl	 eax,FATSECTCNTPWR
    158	    00AB  66| 03 06 0000e			 add	 eax,FATStart
    159	    00B0  6A 20					 push	 FATSECTCOUNT
    160	    00B2  1E					 push	 ds
    161	    00B3  68 0000r				 push	 offset	FAT
    162	    00B6  66| 50				 push	 eax
    163	    00B8  E8 0000e				 call	 ReadSectors
    164	    00BB  83 C4	0A				 add	 sp,10
    165
    166	    00BE  66| 8B C6				 mov	 eax,esi
    167	    00C1  66| 25 FFFFF000			 and	 eax,INMEMCLUSTSCALE
    168	    00C7  C3					 ret
    169	    00C8			 ReadFAT	 endp
    170
    171					 ;ReadCluster:
Turbo Assembler	 Version 3.1	    09/03/18 18:04:28	    Page 4
fat32.asm



    172					 ; On entry:
    173					 ;	 edi ->	Buffer
    174					 ;	 esi = Cluster
    175	    00C8			 ReadCluster	 proc
    176	    00C8  66| 8B C6				 mov	 eax,esi
    177	    00CB  66| 0F B7 0E 0000e			 movzx	 ecx,ClusterSectSize
    178	    00D1  66| 83 E8 02				 sub	 eax,2
    179	    00D5  66| 0F AF C1				 imul	 eax,ecx
    180	    00D9  66| 03 06 0000e			 add	 eax,DataStart
    181	    00DE  FF 36	0000e				 push	 ClusterSectSize
    182	    00E2  66| 57				 push	 edi
    183	    00E4  66| 50				 push	 eax
    184	    00E6  E8 0000e				 call	 ReadSectors
    185	    00E9  83 C4	0A				 add	 sp,10
    186	    00EC  C3					 ret
    187	    00ED			 ReadCluster	 endp
    188
    189							 end
Turbo Assembler	 Version 3.1	    09/03/18 18:04:28	    Page 5
Symbol Table




Symbol Name			  Type	 Value

??DATE				  Text	 "09/03/18"
??FILENAME			  Text	 "fat32	  "
??TIME				  Text	 "18:04:28"
??VERSION			  Number 030A
@32BIT				  Text	 0
@CODE				  Text	 DGROUP
@CODESIZE			  Text	 0
@CPU				  Text	 0F8FH
@CURSEG				  Text	 _TEXT
@DATA				  Text	 DGROUP
@DATASIZE			  Text	 0
@FILENAME			  Text	 FAT32
@INTERFACE			  Text	 00H
@MODEL				  Text	 1
@STACK				  Text	 DGROUP
@WORDSIZE			  Text	 2
CLUSTERBYTESIZE		       +  Word	 DGROUP:---- Extern
(ClusterByteSize)
CLUSTERSECTSIZE		       +  Word	 DGROUP:---- Extern
(ClusterSectSize)
DATASTART (DataStart)		  Dword	 DGROUP:---- Extern
FAT				  Word	 DGROUP:0000
FATSECTCNTPWR			  Number 0005
FATSECTCOUNT			  Number 0020
FATSTART (FATStart)		  Dword	 DGROUP:---- Extern
GETNEXTCLUSTER			  Near	 DGROUP:008A
INMEMCLUST			  Number 1000
INMEMCLUSTPWR			  Number 000C
INMEMCLUSTSCALE			  Number -1000
LFINDENTRYLOOP			  Near	 DGROUP:0043
LNEXTENTRY			  Near	 DGROUP:0071
LOCATE				  Near	 DGROUP:0030
LREADLOOP			  Near	 DGROUP:003E
MEMCOMPARE (MemCompare)		  Near	 DGROUP:---- Extern
NOTFOUNDEXIT			  Near	 DGROUP:0086
READCLUSTER			  Near	 DGROUP:00C8
READFAT				  Near	 DGROUP:00A0
READFILE (ReadFile)		  Near	 DGROUP:0000
READFILEEXIT			  Near	 DGROUP:002A
READLOOP			  Near	 DGROUP:0014
READSECTORS (ReadSectors)	  Near	 DGROUP:---- Extern
ROOT				  Byte	 DGROUP:2000
ROOTCLUSTER (RootCluster)	  Dword	 DGROUP:---- Extern

Structure Name			  Type	Offset

TFAT32DIRENTRY
 FILENAME			  Byte	 0000
 EXTENSION			  Byte	 0008
 ATTRIBUTE			  Byte	 000B
 NT				  Word	 000C
 CREATETIME			  Word	 000E
 CREATEDATE			  Word	 0010
 ACCESSED			  Word	 0012
Turbo Assembler	 Version 3.1	    09/03/18 18:04:28	    Page 6
Symbol Table



 STARTCLUSTERH			  Word	 0014
 TIME				  Word	 0016
 DATE				  Word	 0018
 STARTCLUSTERL			  Word	 001A
 FILESIZE			  Dword	 001C

Groups & Segments		  Bit Size Align  Combine Class

DGROUP				  Group
  _BSS				  16  6000 Word	  Public  BSS
  _DATA				  16  0000 Word	  Public  DATA
  _TEXT				  16  00ED Word	  Public  CODE
