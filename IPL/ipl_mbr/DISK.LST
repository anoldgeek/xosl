Turbo Assembler	 Version 3.1	    17/03/18 19:46:46	    Page 1
disk.asm



      1					 ;
      2					 ; Extended Operating System Loader (XOSL)
      3					 ; Copyright (c) 1999 by Geurt Vos
      4					 ;
      5					 ; This	code is	distributed under GNU General Public License (GPL)
      6					 ;
      7					 ; The full text of the	license	can be found in	the GPL.TXT file,
      8					 ; or at http://www.gnu.org
      9					 ;
     10
     11					 ;/*
     12					 ; * File  : DISK.ASM
     13					 ; * Author: Geurt Vos
     14					 ; * Date  : March 1999
     15					 ; *
     16					 ; * Reads sectors from	the 'mapped' partition
     17					 ; */
     18
     19	    0000					 .model	 tiny
     20							 .386p
     21	    0000					 .data
     22
     23							 extrn	 DriveNumber: byte
     24							 extrn	 DiskSectors: dword
     25							 extrn	 DiskHeads: dword
     26							 extrn	 ABSSectorStart: dword
     27
     28	    0000					 .code
     29							 public	 ReadSectors
     30
     31					 ;int ReadSectors(unsigned long	Sector,	void *Buffer, int Count)
     32	    0000			 ReadSectors	 proc
     33	    0000  55					 push	 bp
     34	    0001  8B EC					 mov	 bp,sp
     35
     36	    0003  66| 8B 46 04				 mov	 eax,[bp + 4]
     37
     38							 ; Locate the sector on	current	partition
     39	    0007  66| 03 06 0000e			 add	 eax,ABSSectorStart
     40	    000C  66| 33 D2				 xor	 edx,edx
     41	    000F  66| F7 36 0000e			 div	 DiskSectors
     42	    0014  42					 inc	 dx
     43	    0015  8B CA					 mov	 cx,dx
     44	    0017  66| 33 D2				 xor	 edx,edx
     45	    001A  66| F7 36 0000e			 div	 DiskHeads
     46
     47	    001F  8A F2					 mov	 dh,dl
     48	    0021  8A 16	0000e				 mov	 dl,DriveNumber		 ;dx = drvhead
     49
     50	    0025  86 E0					 xchg	 ah,al
     51	    0027  C0 E0	06				 shl	 al,6
     52	    002A  0B C8					 or	 cx,ax			 ;cx = sectcyl
     53	    002C  33 C0					 xor	 ax,ax
     54
     55	    002E  B4 02					 mov	 ah,02h
     56	    0030  8A 46	0C				 mov	 al,[bp	+ 12]
     57	    0033  C4 5E	08				 les	 bx,[bp	+ 8]
Turbo Assembler	 Version 3.1	    17/03/18 19:46:46	    Page 2
disk.asm



     58	    0036  CD 13					 int	 13h
     59	    0038  1B C0					 sbb	 ax,ax			;ax = cf ? -1 :	0
     60
     61	    003A  5D					 pop	 bp
     62	    003B  C3					 ret
     63	    003C			 ReadSectors	 endp
     64
     65							 end
Turbo Assembler	 Version 3.1	    17/03/18 19:46:46	    Page 3
Symbol Table




Symbol Name			  Type	 Value

??DATE				  Text	 "17/03/18"
??FILENAME			  Text	 "disk	  "
??TIME				  Text	 "19:46:46"
??VERSION			  Number 030A
@32BIT				  Text	 0
@CODE				  Text	 DGROUP
@CODESIZE			  Text	 0
@CPU				  Text	 0F8FH
@CURSEG				  Text	 _TEXT
@DATA				  Text	 DGROUP
@DATASIZE			  Text	 0
@FILENAME			  Text	 DISK
@INTERFACE			  Text	 00H
@MODEL				  Text	 1
@STACK				  Text	 DGROUP
@WORDSIZE			  Text	 2
ABSSECTORSTART (ABSSectorStart)	  Dword	 DGROUP:---- Extern
DISKHEADS (DiskHeads)		  Dword	 DGROUP:---- Extern
DISKSECTORS (DiskSectors)	  Dword	 DGROUP:---- Extern
DRIVENUMBER (DriveNumber)	  Byte	 DGROUP:---- Extern
READSECTORS (ReadSectors)	  Near	 DGROUP:0000

Groups & Segments		  Bit Size Align  Combine Class

DGROUP				  Group
  _DATA				  16  0000 Word	  Public  DATA
  _TEXT				  16  003C Word	  Public  CODE
